@      NOLIST EXT
       MACRO DP←DEFINE PARAMETER;
       MACRO DE←DEFINE REGISTER;
       MACRO SC←DEFINE SCONDITION;
       MACRO BC←DEFINE BCONDITION;

* MISCELLANEOUS
       DP ADMASK←77000000B;

* SIZES AND LOCATIONS OF THINGS IN THE USCHEDULER
       DP NPRI←8;
* THIS PROGRAM WILL NOT WORK WITH MORE THAN TWO
* CPUS. THE EXISTENCE OF JUST TWO IS WOVEN INTO THE CODE IN SEVERAL
* PLACES.
       DP NCPU←2;
* CONVENTIONS FOR ACCESS LEVELS: INCREMENT BY RCY 4, IDLE IS 4B7
       DP ALIDLE←4B7;
       DP ALRUNNING←2B6;
       DP ALPRIMED←1B5;
* CONVENTIONS FOR PRIORITIES: 0 TO NPRI-1, WITH 0 MOST IMPORTANT
       DP LUSIBE←2;            * LENGTH OF USIB ENTRY
       DP MAXUOP←10;           * MAX LEGAL OPCODE FOR USIB ENTRY
       DP LSCRATCH←32;         * SIZE OF SCRATCHPAD

* FIELDS IN A PRT ENTRY
       DP RTBIT←1; DP RSIBIT←2;
       DP RESBIT←4; DP CPUBIT←1; DP RUNBIT←2; DP LDDBIT←10B;
       DP USQBIT←20B; DP SCQBIT←40B; DP SWQBIT←100B; DP PQBIT←200B;
       DP PDKBIT←400B; DP CBCBIT←1000B; DP WAQBIT←2000B; DP BLKBIT←4000B;
       DP PRRTP←6; DP PRRT←7;
       DP PRST←8; DP PRPIW←3;
       DP PRPTR←11;
       DP RTPMSK←77000000B;
       DP PRIMASK←160000B;

* FIXED CORE LOCATIONS FOR COMMUNICATING WITH OTHER PEOPLE
       DP RTC←10B;             * REAL-TIME CLOCK (48 BITS). WE ARE
* INTERESTED IN BITS 15-37. THE MOST SIGNIFICANT BITS ARE IN THE
* FIRST WORD
       DP RTQ←16B;             * HEAD OF REAL-TIME QUEUE
       DP USIBTOP←15B;         * POINTER TO TOP OF USIB
       DP USIBASE←14B;         * POINTER TO BASE OF USIB
       DP SWFREL←110B;         * HEAD OF FREELIST OF SWAPPER NODES
       DP SWAPIQ←106B;         * HEAD OF QUEUE FOR SWAPIN REQUESTS
       DP SWAPRQ←104B;         * HEAD OF SWAPPER GENERAL REQUEST QUEUE
       DP RIPQ←114B;           * HEAD OF SWAPPER READ IN PROGRESS Q
       DP CPUPROC←6;           * PROCESSES FOR CPU(S) TO RUN
       DP USQBASE←310B;
       DP WAKEUPQ←300B;

* PARAMETERS DEFINING THE SAVE AREA, USED BY THE STATE STORE AND
* LOAD ROUTINES
       DP SAVE←2620B;          * SHOULD BE 2620B ON BOARDS
       DP SAVER0←SAVE+LSCRATCH;
* THE CODE SAVES R0-R6, OS, QAND Z IN SEQUENCE
       DP SAVER1←SAVER0+1;
       DP SAVEZ←SAVER0+9;
* A SCRATCHPAD LOCATION MUST BE DEDICATED TO SAVING M
       DE SK0 AS SSMREG;
* THE O REGISTER IS RESTORED FROM
       DP BREAK←21B;
* AND WE WAIT AFTER STORING THE STATE FOR
       DP BRKWAIT←26B;
* TO BECOME NON-ZERO BEFORE STARTING TO RELOAD

* LOCATION OF FOUR-WORD ERROR TABLE FOR US
       DP USERRTAB←2444B;


* PARAMETERS FOR THE ADDRESSES OF SYSTEM REGISTERS.  THE REGISTERS
* ARE ASSUMED TO APPEAR IN SEQUENCE AS LISTED
       DP USRADR←1;
       DP SWR1ADR←USRADR; DP SWR2ADR←USRADR+1; DP SWR3ADR←USRADR+2;
       DP SWR4ADR←USRADR+3; DP SWR5ADR←USRADR+4;
       DP SSRADR←USRADR+5; DP SCRADR←USRADR+6; DP SSLADR←USRADR+7;
* PARAMETERS FOR THE MEMORY REPRESENTATION OF THE REGISTERS
       DP USRMEM←30B;
       DP SWR1MEM←USRMEM; DP SWR2MEM←USRMEM+1; DP SWR3MEM←USRMEM+2;
       DP SWR4MEM←USRMEM+3; DP SWR5MEM←USRMEM+4;
       DP SSRMEM←USRMEM+5; DP SCRMEM←USRMEM+6; DP SSLMEM←USRMEM+7;
* PARAMETERS FOR BITS IN SCR
       DP SCR←5
       DP SELFILLBIT←1; DP COMPUTEBIT←2;
       DP GOBIT←4B7; DP CONTINUEBIT←2B7; * GOBIT TESTED BY SIGN TEST IN CODE

* MACROS FOR READING DATA WORDS.  THE PREVIOUS INSTRUCTION SHOULD
* READ
* Z←ADDRESS, ALERT
* AND THE MACRO US USED THUS:
* M←READ
* WHERE ANY REGISTER WHICH CAN BBE LOADED FROM Y CAN BE USED
* IN PLACE OF M
       MACRO READ←E2, PIN, .VCY;

* PROTECTS
       MACRO PROTECT←.C←*1*, .TCX, SETPRO, GOTO * IF PRONEX;
       MACRO UNPROTECT←.BL←7B .BR←10B .TAX, CLRPRO;
       DP USIBPRO←8;
       DP PRTPRO←1;
       DP SWAPRO←2;
       DP ALLPRO←17B;

* STROBE
       DP CPUSTSH←3;           * SHIFT CPU#(1 OR 2) TO GET STROBE
       DP SWAPSTROBE←1;
       DP CHIOSTROBE←4;
* MISCELLANEOUS
       DP SWAPOP←1;            * RCASA FOR SWAPPER REQUESTS
       DP SWNPTR←5;            * POINTER WORD IN SWAPPER REQUEST NODES

* REGISTER DEFINITIONS
       DE SK1 AS WNPFLG;       * SET IF WAITING FOR CPU TO UNPRIME
       DE SK2 AS OLDRT;        * LAST CLOCK VALUE
       DE SK3 AS TRTQT;        * TIME FOR TOP OF RTQ
       DE SK4 AS SCHFLG;       * SET IF RESCHEDULING REQUIRED
       DP LOCSCHFLG←4;
       DE SK5 AS MINPRT;       * MINIMUM PRT ADDRESS
       DE SK6 AS MAXPRT;       * MAXIMUM PRT ADDRESS
       DE SK7 AS SPT1;
       DE SK8 AS SPT2;
       DE SK9 AS SPT3;         * CHANGERT ONLY
       DE SK9 AS OLDOLDRT;
       DE SK10 AS SPT4;
       DE SK11 AS ADMREG;      * TRUE ADMASK: 777777B
       DE SK13 AS CALLT1;
       DP AL←14;
       DE SK14 AS AL0;
       DE SK15 AS AL1;
       DP PRI←16;
       DE SK16 AS PRI0;
       DE SK17 AS PRI1;

* THE TOP 4 BITS OF
       DE SK28 AS MODE;
* ARE USED TO INDICATE THE MODES, AS FOLLOWS
       DP ONCOMPUTE←4B7; DP WAITCOMPUTE←2B7;
       DP ONSCHEDULE←1B7; DP SAVESCHEDULE←4B6;
* ASSUME THAT THESE BITS AND A MEMORY ADDRESS=0

*  THE FOLLOWING SCRATCHPAD LOCATIONS ARE USED BY THE ITP
* THEY AND MODE MUST BE THE TOP 4
       DE SK29 AS IOCTL;       * I/O CONTROL WORD
       DP LOCIOCTL←29;
       DE SK30 AS REL;         * RELOCATION FOR RELATIVE ADDRESSES
       DE SK31 AS BOUND;       * MEMORY BOUND FOR RELATIVE ADDRESSES
* STORABE FOR THE CENTRAL REGISTERS OF THE ITP
       DE SK24 AS P;
       DE SK25 AS AR;
       DE SK26 AS BR;
       DE SK27 AS XR;
* THE US CAN START ITS STACK JUST BELOW THE ITP'S REGISTERS
       DP TOPSTACK←23;
* CORE LOCATIONS FROM WHICH TO INITIALIZE REL AND BOUND
       DP ITPREL←2B6+306B; DP ITPBND←ITPREL+1;

       DE R0 AS MAR;
       DE R1 AS TEMP1;         * CHRT, TIMINT AND IBEMPTY ONLY
       DE R1 AS CPROC;
       DE R2 AS TEMP2;
       DE R3 AS TEMP3;
       DE R4 AS TEMP4;
       DE R4 AS OFFSET;
       DE R5 AS SUBR;
       DE R6 AS STKP;

* BRANCH CONDITIONS
       BC R0<0,BR0NEG←11B,(SKN R0),NOVCY;
       BC R0>=0,BR0POS←12B,(SKP R0),NOVCY;
       BC NULLPTR←14B,(BRM XNPTR);
       BC NNPTR←15B,(BRM XNNPTR);
       BC Z>=0,BZPOS←16B,(SKP Z),NOVCY;
       BC Z<0,BZNEG←17B,(SKN Z),NOVCY;
       BC Y.7#0,YA7IS0←21B,(BRM XYA7);
       BC LB=0,BLBEQ0←22B,(BRM LBEQ0),NOVCY;
       BC LB#0,BLBNE0←23B,(BRM LBNE0),NOVCY;
       BC YEVEN←24B,(BRM XYEVEN),NOVCY;
       BC YODD←25B,(BRM XYODD),NOVCY;
       BC AT1OFF←26B,(BRM XAT1F),NOVCY;
       BC NOSTROBE←27B,(BRM STROFF),NOVCY;
       BC PRONEX←30B,(BRM XPRONE);
       BC NOCRASH←31B,(SKP FAILF),NOVCY;
       BC ASET←33B,(SKN AFLAG),NOVCY;
       BC ACLEAR←32B,(SKP AFLAG),NOVCY;
       BC AT2OFF←34B,(BRM XAT2F),NOVCY;
       BC AT3OFF←35B,(BRM XAT3F),NOVCY;
       BC AT1ON←36B,(BRM XAT1N),NOVCY;
       BC LMPARITY←42B,(NOP),NOVCY;
       BC CMPARITY←43B,(NOP),NOVCY;
       BC BRKON←45B,(BRM XBRKON),NOVCY;

* SPECIAL CONDITIONS
       SC ALERT←14B,(BRM XALERT);
       SC POT←15B,(BRM XPOT),NOVCY;
       SC PIN←16B,(BRM XPIN);
       SC STROBE←17B,(BRM SETSTR);
       SC CLRPRO←20B,(BRM CPRO),NOVCY;
       SC LMPRI←22B,(NOP),NOVCY;
       SC CLSTROBE←23B,(BRM XCLSTR),NOVCY;
       SC CLRCM←24B,(NOP),NOVCY;
       SC SETPRO←25B,(BRM SPRO);
       SC SETA←30B,(BRM XSETA),NOVCY;
       SC CLRA←31B,(BRM XCLRA),NOVCY;

       SC CLFAIL←32B,(MIN FAILF),NOVCY;
       SC SETFAIL←33B,(NOP);

       END;