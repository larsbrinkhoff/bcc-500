}'COMMON SYSCALLS;

* MCALL DECLARATIONS


* CALLS TO MANIPULATE MIBS AND SIBS
}'INTEGER MONITOR CREATE'MIB _ 190;
}'UNKNOWN MONITOR READ'MIBOB'INDEX _ 0;
}'UNKNOWN MONITOR READ'MIBOB'NAME _ 1;
}'UNKNOWN MONITOR SET'MIBOB'NAME _ 2;
}'UNKNOWN MONITOR SET'MIBOB'ACCESS _ 3;
}'UNKNOWN MONITOR SET'LOCK'LIST _ 4;
}'UNKNOWN MONITOR DELETE'MIBOB _ 5;
}'INTEGER MONITOR CREATE'MIBOB _ 6;
}'UNKNOWN MONITOR SET'MIB'ACCESS _ 10;
}'INTEGER MONITOR READ'MIB'ACCESS _ 11;
}'UNKNOWN MONITOR SET'MIBOB'VALUE _ 12;
}'INTEGER MONITOR COPY'MIBOB _ 14;* UNIMPLEMENTED
}'UNKNOWN MONITOR SET'NO'CHARGE _ 15;*** ???
}'INTEGER MONITOR READ'MIB'SPACE _ 16;
}'UNKNOWN MONITOR SET'FILE'LOCK _ 18;*?* UNIMPLEMENTED
}'UNKNOWN MONITOR SET'DURABILITY _ 28;*** ???

* OFT CALLS
}'INTEGER MONITOR MOPEN'FILE _ 19;
}'UNKNOWN MONITOR MREAD'OFT _ 20;
}'UNKNOWN MONITOR SET'OFT'AL _ 21;
}'INTEGER MONITOR MSET'OFT'CL _ 22;
}'UNKNOWN MONITOR SET'FILE'LENGTH _ 23;* IMPROVE THIS FOR UTS
}'INTEGER MONITOR CR'FILE'PAGE _ 24;
}'INTEGER MONITOR DEL'FILE'PAGE _ 25;
}'INTEGER MONITOR NEXT'FILE'PAGE _ 26;
}'UNKNOWN MONITOR MOVE'PAGE'PMT _ 27;

* PMT CALLS
}'INTEGER MONITOR ACQUIRE'PMT _ 50;
}'UNKNOWN MONITOR NEW'PMT'PAGE _ 51;
}'UNKNOWN MONITOR CLEAR'PMT _ 53;
}'UNKNOWN MONITOR DELETE'PMT _ 54;
}'UNKNOWN MONITOR SET'PMT'AL _ 55;
}'UNKNOWN MONITOR SET'PMT'CL _ 56;
}'UNKNOWN MONITOR SET'PMT'RO _ 57;
}'UNKNOWN MONITOR READ'PMT _ 58;

* WORKING SET CALLS
}'UNKNOWN MONITOR PUT'PAGE'DWS _ 65;
}'UNKNOWN MONITOR PUT'PAGE'CWS _ 66;
}'INTEGER MONITOR DEL'PAGE'DWS _ 67;
}'INTEGER MONITOR DEL'PAGE'CWS _ 68;
}'INTEGER MONITOR READ'LWS _ 70;
}'UNKNOWN MONITOR SET'LWS _ 71;

* SPT CALLS
}'INTEGER MONITOR MCREATE'SP _ 90;
}'UNKNOWN MONITOR MDESTROY'SP _ 91;
}'UNKNOWN MONITOR MREAD'SPT _ 95;
}'UNKNOWN MONITOR READ'SPCS _ 96;
}'INTEGER MONITOR MRD'SPT'FIELD _ 97;
}'UNKNOWN MONITOR MST'SPT'FIELD _ 98;
}'UNKNOWN MONITOR READ'MAP _ 99;
}'UNKNOWN MONITOR SET'MAP _ 100;
}'INTEGER MONITOR READ'MAP'BYTE _ 101;
}'UNKNOWN MONITOR SET'MAP'BYTE _ 102;
}'INTEGER MONITOR READ'SPS'PARAM _ 106;

* SPCS CALLS
}'UNKNOWN MONITOR SP'CALL _ 111;
}'UNKNOWN MONITOR SP'JUMP _ 112;
}'UNKNOWN MONITOR SP'TRAP _ 113;
}'UNKNOWN MONITOR TRAP'RETURN _ 114;
}'UNKNOWN MONITOR SP'BRANCH _ 115;
}'UNKNOWN MONITOR SP'RETURN _ 116;
}'UNKNOWN MONITOR JUMP'RETURN _ 117;
}'UNKNOWN MONITOR MARK'CALL _ 118;
}'UNKNOWN MONITOR DELETE'CALL _ 119;
}'UNKNOWN MONITOR MODIFY'CALL _ 120;

* PROCESS CALLS
}'INTEGER MONITOR COPY'PMT'PROC _ 130;
}'INTEGER MONITOR ACTIVATE'PROC _ 132;
}'UNKNOWN MONITOR TRANSFER'TERM _ 133;
}'UNKNOWN MONITOR MAKE'DORMANT _ 134;
}'UNKNOWN MONITOR INIT'PROC'PAGE _ 135;
}'UNKNOWN MONITOR INIT'PROC'MAP _ 136;
}'UNKNOWN MONITOR INIT'SPT _ 137;
}'INTEGER MONITOR READ'PROC'PARAM _ 211;

* IWS CALLS
}'UNKNOWN MONITOR SET'PROC'INT _ 163;
}'UNKNOWN MONITOR QUIT'BLOCK _ 164;
}'INTEGER MONITOR GET'INT'NO _ 165;
}'UNKNOWN MONITOR READ'ICT _ 166;
}'UNKNOWN MONITOR ALLOW'INTS _ 168;
}'UNKNOWN MONITOR REFUSE'INTS _ 169;
}'UNKNOWN MONITOR BLOCK _ 170;
}'UNKNOWN MONITOR SET'ICT _ 172;
}'UNKNOWN MONITOR SET'ICT'CL _ 173;
}'INTEGER MONITOR ACQUIRE'ICT _ 174;

* CHIO CALLS
}'UNKNOWN MONITOR SET'LINE'FIELD _ 180;
}'UNKNOWN MONITOR READ'LINE'TABLE _ 181;
}'UNKNOWN MONITOR READ'STRING'BRK _ 182;
}'UNKNOWN MONITOR WRITE'STRING _ 183;

* MISCELLANEOUS
}'LONG MONITOR}"READ'CLOCK _ 210;

* UCALL DECLARATIONS


* MISCELLANEOUS UCALLS
}'UNKNOWN UTILITY BREAK'POINT _ 0;*}-UCALL FOR DEBUGGING PROGRAMS
}'STRING UTILITY ERRORMSG _ 1;*}0RETURN SYSTEM ERROR MESSAGE
}'STRING UTILITY GET'PARAM _ 2;*}/STRIP PARAMETER FROM STRING
}'STRING UTILITY GET'COM'LINE _ 3;*},GET CURRENT COMMAND LINE FROM UTS
}'INTEGER UTILITY ABRV'LKP _ 4;*}0LOOK UP ABBREVIATED NAME IN STARY
}'INTEGER UTILITY CON'ABRV'LKP _ 5;*},CONTINUE SAME IN NEW STARY

* FILE SYSTEM CALLS
}'UNKNOWN UTILITY NAME'SEARCH _ 10;*},CONVERT FILE ST TO UTS NAME
}'UNKNOWN UTILITY SPECIAL'SEARCH _ 11;*})VARIATION OF ABOVE
}'INTEGER UTILITY CONV'NAME _ 12;*}.CONVERT FROM UTS TO MON FILE NAME
}'LONG UTILITY SPREAD'NAME _ 13;*},SPLIT FILE NAME STRING INTO COMP.
}'UNKNOWN UTILITY READ'MIBOB'VALUE _ 14;*}'READ 'VALUE' OF MIB OBJECT
}'UNKNOWN UTILITY DELETE'FILE _ 15;*},DELETE FILE AND CONTENTS
}'INTEGER UTILITY OPEN'FILE _ 16;*}.OPEN FILE W/WO LOCKING
}'UNKNOWN UTILITY CLOSE'FILE _ 17;*}-CLOSE AND UNLOCK FILE
}'UNKNOWN UTILITY READ'OFT _ 18;*}/READ OFT
}'INTEGER UTILITY READ'OFT'FIELD _ 19;*})READ OFT FIELD
}'UNKNOWN UTILITY SET'OFT'CL _ 20;*}-SET OFT CONTROL LOCK
}'INTEGER UTILITY CONV'KEY _ 21;*}/CONVERT DEFAULT ACCESS KEY

* EXTENDED SPS CALLS
}'INTEGER UTILITY CREATE'SSP _ 30;*}-CREATE SUBSIDIARY SUB-PROCESS
}'INTEGER UTILITY CREATE'PSP _ 31;*}-CREATE PARALLEL SUB-PROCESS
}'UNKNOWN UTILITY ATTACH _ 32;*}1ATTACH PI FILE TO SUB-PROCESS
}'UNKNOWN UTILITY DESTROY'SP _ 33;*}-DESTROY SUB-PROCESSES
}'UNKNOWN UTILITY READ'SPT _ 34;*}/READ SPT
}'INTEGER UTILITY READ'SPT'FIELD _ 35;*})READ SPT FIELD
}'UNKNOWN UTILITY SET'SPT'FIELD _ 36;*}*SET SPT FIELD
}'STRING UTILITY READ'SPNAME _ 37;*},READ SUB-PROC NAME
}'UNKNOWN UTILITY SET'SPNAME _ 38;*}-SET SUB-PROC NAME
}'INTEGER UTILITY SPNAME'SEARCH _39;*}+LOOK UP SP NAME

* CIOS MANIPULATION
}'INTEGER UTILITY CREATE'CIOS _ 40;*},CREATE CONTROL I/O STREAM
}'INTEGER UTILITY READ'CIOS'FIELD _ 41;*}(READ CIOS FIELD
}'UNKNOWN UTILITY SET'CIOS'FIELD _ 42;*})SET (SOME) CIOS FIELDS
}'UNKNOWN UTILITY SET'CIOS'INPUT _ 43;*})SET UP FOR INPUT
}'UNKNOWN UTILITY SET'CIOS'OUTPUT _ 44;*}(SET UP FOR OUTPUT

* CIOS INPUT/OUTPUT
}'UNKNOWN UTILITY PRINT'STRING _ 45;*}+WRITE STRING ON CIOS
}'UNKNOWN UTILITY PRINT'CHAR _ 46;*}-WRITE (= BUFFER) CHAR ON CIOS
}'UNKNOWN UTILITY START'OUTPUT _ 47;*}+DUMP OUTPUT BUFFER
}'STRING UTILITY READ'LINE _ 48;*}.READ NEXT INPUT LINE
}'STRING UTILITY EDIT'LINE _ 49;*}.EDIT CURRENT LINE
}'CHARACTER UTILITY READ'CHAR _ 50;*}.READ NEXT CHARACTER
}'UNKNOWN UTILITY BLOCK'OB'EMPTY _ 51;*})WAIT UNTIL OUT BUFFER IS EMPTY

* USER, ACCOUNT, AND GROUP PROFILES
}'STRING UTILITY READ'UP'ITEM _ 60;*}+READ ITEM FROM USER PROFILE
}'STRING UTILITY READ'UP'NAMES _ 61;*}*READ NAMES OF UP ITEMS
}'UNKNOWN UTILITY SET'UP'ITEM _ 62;*},SET (CREATE) VALUE OF UP ITEM
}'UNKNOWN UTILITY SET'UP'ACCESS _ 63;*}*SET ACCESS TO UP ITEM
}'LONG UTILITY FIND'MIB _ 64;*}/CONVERT USER NAME/NUMBER TO MIB ADDR
}'INTEGER UTILITY CREATE'UP'ENTRY _ 65;*}(CREATE USER/UP ENTRY
}'UNKNOWN UTILITY DELETE'UP'ENTRY _ 66;*}(DELETE USER/UP ENTRY

* PROCESSES, AND PROCESS PROFILE
}'UNKNOWN UTILITY CREATE'PROCESS _ 70;*})CREATE/INITIALIZE PROCESS
}'STRING UTILITY READ'PP'ITEM _ 71;*}+READ ITEM FROM PROCESS PROFILE
}'STRING UTILITY READ'PP'NAMES _ 72;*}*READ NAMES OF PP ITEMS
}'UNKNOWN UTILITY SET'PP'ITEM _ 73;*},SET (CREATE) VALUE OF PP ITEM

}'COMMON M1'COMM;
}'INCLUDE COMM,SYSCALLS;
*
* COMMON STORAGE FOR MRUN
*
}'DA RING'FILES[NRINGS+2];* FILES FOR RING DATA
}'DI CODE'FILE=RING'FILES[NRINGS];* FILE FOR CODE
}'DI BARE'FILE=RING'FILES[NRINGS+1];* FILE FOR ABSOLUTE CORE
}'DI REAL'FILE;* REAL FILE NUMBER
}'DA NAME'BUF[8];* BUFFER FOR FILE NAME
}'DI M1'FILE'TYPE=NAME'BUF[7];
}'DA FILE'TYPES[5]_(6'',6'9SAV',6'9BIN',6'9SYM',6'9DMP');
*}.940 FILE TYPES
}'DA PMT'BYTES[64];* PMT BYTES
}'DA PMT'USE[64];* BOOK-KEEPERS FOR PMT'BYTES
}'DF PMT'FILE(0:0,11), PMT'PAGE(0:12,23);
}'DECLARE INTEGER ERMSNO, CHARACTER ERCODE;* SYSTEM ERROR CODES
}'DM SYSEC_ERCODE,ERMSNO;* FOR FAILURE RETURNS
}'DM SYSERR_VALUE SYS'ERR():SYSEC;
}'DI SP'=G'[2],SL'=G'[3];* STACK POINTER AND LIMIT
}'DECLARE ARRAY STACK [4000B];* HOPEFULLY, UNNECESSARILY LARGE
}'DI INIT'SP_@STACK[0],INIT'SL_@STACK[3777B];* STACK BOUNDS

}'PROGRAM MISC'RUN;
}'INCLUDE M1'COMM;

}'DECLARE STRING S,S', INTEGER FILE,X,Y,K,L,M,N, POINTER S1,S2;
}'DECLARE OCTAL LSUB0=L'[0];
}'DECLARE ARRAY DIGITS[25];
}'DECLARE FIELD WD0(0),WD1(1);
}'DFF ST'CSIZE(0:2,3);
}'DECLARE STRING FIELD STRING'F(0);

* OUTPUT STRING TO TERMINAL
}'FUNCTION CSOUT(S);
SOUT:}"PRINT'STRING(-1,S,0//SOS:S,SYSEC);
}'RETURN;
SOS:}#SYS'ERR() IF ERCODE # 'QIT';
}'GOTO QUITGO IF
}+(QUITMODE = 1 OR (QUITF _ QUITF + 1) >= QUIT'ABORT'LEVEL);
}'RETURN IF LENGTH(S) = 0 ELSE GOTO SOUT;

* OUTPUT STRING TO FILE
}'FUNCTION COUT(X,FILE);
}'SETUP(S,3,@X);
}'SETS(S,2,3);
}'FUNCTION FSOUT(S,FILE);
}'GOTO SOUT IF FILE=-1;* TELETYPE
}'WCI'TO'FILE(FILE,S);
}'RETURN;

* SYSTEM FAILURES
}'FUNCTION RUNTIME'FAILURE();
}'FMTO("/RUNTIME FAILURE AT P = #B/"); OUT(LSUB0);
}'EXIT();
}'.HLT 2;
}'FUNCTION SYS'ERR();
}'CSOUT("&/SYSTEM CALL FAILED: CODE = ");
}'SETUP(S, 3, @ERCODE);
}'SETS(S, 0, 3);
}'CSOUT(S);
}'FMTO(", NUMBER = */"); OUT(ERMSNO);
}'FMTO("AT P =#B/"); OUT (LSUB0);
}'EXIT();
}'.HLT 3;
}'FUNCTION FATAL'ERROR();
}'FMTO("/FATAL ERROR AT P = #B/"); OUT(LSUB0);
}'EXIT();
}'.HLT 4;

* LOCATE LEADING ONE
}'FUNCTION FLLO(X);
}'.LDA X, BGT R'[2], ZAB, LLT, STX X;
}'RETURN X;

* COUNT ONE-BITS
}'FUNCTION FCOB(X);
}'.LDA X, ZOB, COB, STX X;
}'RETURN X;

* APPEND STRING TO STRING
}'FUNCTION SCOPY(STRING @S1,S), FRETURN;
}'S1.WP_S1.RP_S1.BP;
}'FUNCTION APPEND(STRING @S1,S), FRETURN;
}'FUNCTION APPND(STRING @S1,S), FRETURN;
}'S'_S1.STRING'F;
}'FRETURN IF LENGTH(S)>LNGDES(S'$WP,S'$EP);
}'FATAL'ERROR() IF S$ST'CSIZE#S'$ST'CSIZE;
APP1:}"WCI(GCI(S//APP2),S');
}'GOTO APP1;
APP2:}"S1.WP_S'$WP;
}'RETURN;

* CONVERT NUMBER TO STRING
}'STRING FUNCTION CNS(X,STRING @S1,INTEGER L,N), FRETURN;
}'STRING FUNCTION FCNS(X,STRING @S1,INTEGER L,N), FRETURN;
}'RUNTIME'FAILURE() IF N<2 OR N>400B;
}'S_S1.STRING'F;
}'Y_(X IF X>=0 OR L<0 ELSE -X);
}'K_0;
CNS1:}".LDA Y, LSHD -23, DIV N, STA Y, STB M;
}'DIGITS[K]_M+'0';
}'K_K+1;
}'GOTO CNS1 IF Y;
}'IF X<0 AND L>=0 DO;
}*DIGITS[K]_'-';
}*K_K+1;
}'ENDIF;
}'K_M IF (M_L A' 77B)#0 AND M<K;
}'WCI(DIGITS[K],S//FRETURN) FOR K_K-1 BY -1 TO 0;
}'S1.WP_S$WP;
}'RETURN S;


* CALCULATE COMPUTE TIME IN MILLISECONDS FROM 2 48-BIT
* COMPUTE TIME CLOCK VALUES.
}&FUNCTION MS'COMPUTE'TIME(LONG TIME'1,TIME'2);
}*.LDA TIME'2$WD1,.SUB TIME'1$WD1,.CAB;
}*.LDA TIME'2$WD0,.SUC TIME'1$WD0;
}*.DIV 50;*CONVERTING FROM 10 MICROSECS TO MILLISECS
}*.STA X;
}*RETURN X;

* READ NUMBER OF PAGE FAULTS.
}'FUNCTION PAGE'FAULTS();
}'RETURN READ'PROC'PARAM('PFC'//SYSERR);
}'END;*
}'PROGRAM EXIT;
}'INCLUDE M1'COMM;
}'DECLARE INTEGER
}*CURRENT'SPCSL, LEVEL, CURRENT'L'REG, CURRENT'G'REG;

}'FUNCTION EXIT();
* UNWIND SUB-PROCESS CALL STACK IF NECESSARY.
}'CURRENT'SPCSL _ READ'SPS'PARAM('CSL'//SYSERR);
}'IF CURRENT'SPCSL # SPL'SPCSL DO;
}*LEVEL _ CURRENT'SPCSL - SPL'SPCSL - 1;
}*.CLA; .STA CURRENT'L'REG; .CGA; .STA CURRENT'G'REG;
}*MODIFY'CALL(LEVEL, @RE'ENTRY'POINT, CURRENT'L'REG, CURRENT'G'REG, 0//SYSERR);
}*JUMP'RETURN(LEVEL//SYSERR);
}'ENDIF;
RE'ENTRY'POINT:
* SET OLCWS AND OLDWS BACK TO WHAT THEY WERE WHEN SPL WAS ENTERED.
}'SET'WS'SIZE(SAVED'OLCWS, SAVED'OLDWS);
* EXIT.
}'SP'RETURN(//VALUE HALT(): SYSEC);

}'FUNCTION HALT();
}'.HLT 0;
}'END;*
}'PROGRAM ZEDIT;
* EDIT (COLLECT) LINE
}'INCLUDE M1'COMM;
}'DECLARE STRING S, S', NS(200);
}'DECLARE INTEGER DUM1;

* 7/14/73}"JACK FREEMAN
* THIS FUNCTION SHOULD EVENTUALLY BE CHANGED IN A NUMBER OF WAYS:
* (1) THE LOCAL STRING NS (200 CHARACTERS!) SHOULD BE GOTTEN RID OF.
*}%IT SHOULD BE PASSED AS AN ARGUMENT.
* (2) SOME OF THE CALLERS OF ZEDIT SHOULD PROBABLY CALL EDIT'LINE
*}%DIRECTLY INSTEAD.
* (3) THE CALL BELOW ON EDIT'LINE SHOULD PASS REALISTIC VALUES FOR
*}%INSERT'MODE (THE 1ST 0) AND QUIT'FLAG (THE 2ND 0).}"DUM1 IN THE
*}%FAILURE RETURN LIST SHOULD BE SOME SORT OF INSERT'MODE VARIABLE.
* (4) SOMETHING MORE REASONABLE SHOULD BE DONE ABOUT FAILURES OF
*}%EDIT'LINE, IN PARTICULAR THE ONE DUE TO QUIT.
* (5) A MORE REASONABLE CHARACTER THAN '%' SHOULD BE USED TO TERMINATE
*}%EDITS.

}'STRING FUNCTION ZEDIT(S,N,X),FRETURN;
}'SETUP(S',1,@X);
}'WCI(X,S') IF X>=0;
}'SETS(NS);
}'NS _ EDIT'LINE(-1, S, NS, 0, S', 0//EDIT1:S, NS, DUM1, SYSEC);
}'SCOPY(S, NS//EDIT1);
}'EDTERM _ GCD(S//VALUE RETURN S);
}'IF EDTERM # '%' DO;
}+WCI(EDTERM,S//VALUE RUNTIME'FAILURE());
}'ENDIF;
}'RETURN S;
EDIT1: SYS'ERR() IF ERCODE#'QIT';
*** PUNT FOR NOW
}'EXIT();
}'END;*
}'PROGRAM ARRAY'RUN;
}'INCLUDE SCMWF;
}'DECLARE INTEGER LARGE'ELEMENT, UPPER'BOUND, KLUDGE;
}'DECLARE FIELD MULTIPLIER, UPPER'LIMIT;
}'DECLARE ARRAY DESCRIPTOR;

}'ARRAY FUNCTION ARRDESC(BASE'ADDRESS, NO'OF'ELEMENTS,
}>ELEMENT'SIZE, LOWER'BOUND);
* CONSTRUCT ARRAY DESCRIPTOR WITH GIVEN BASE ADDRESS, NUMBER OF ELEMENTS,
* ELEMENT SIZE, AND LOWER BOUND.

* CHECK BASE'ADDRESS, ELEMENT'SIZE, AND LOWER'BOUND.
}'RUNTIME'FAILURE() IF
}*(BASE'ADDRESS<0 OR BASE'ADDRESS>(-1)$IWGD) OR
}*(ELEMENT'SIZE<1 OR ELEMENT'SIZE>(-1)$AIWLMULT+1) OR
}*(LOWER'BOUND<0 OR LOWER'BOUND>1);
* SET UP FOR LARGE OR SMALL ELEMENT CASE.
}'IF ELEMENT'SIZE<=4 DO;
}*LARGE'ELEMENT _ 0;
}*MULTIPLIER _}"AIWNMULT;
}*UPPER'LIMIT _ AIWNLIM;
}'ELSE DO;
}*LARGE'ELEMENT _ 1;
}*MULTIPLIER _ AIWLMULT;
}*UPPER'LIMIT _ AIWLLIM;
}'ENDIF;
* COMPUTE AND CHECK UPPER'BOUND.}"NOTE THE SPECIAL KLUDGERY FOR
* THE CASE WHERE THE NUMBER OF ELEMENTS IS ZERO.
}'UPPER'BOUND _
}*LOWER'BOUND+(NO'OF'ELEMENTS-1 IF NO'OF'ELEMENTS>0 ELSE 0);
}'KLUDGE _ -1;* BECAUSE (-1)$UPPER'LIMIT COMPILES WRONG.
}'RUNTIME'FAILURE() IF
}*UPPER'BOUND<LOWER'BOUND OR UPPER'BOUND>KLUDGE$UPPER'LIMIT;
* CONSTRUCT AND RETURN THE DESCRIPTOR.
}'DESCRIPTOR$IWTYPE _ IWTARR;
}'DESCRIPTOR$AIWORG _ LOWER'BOUND;
}'DESCRIPTOR$AIWMIB _ 0;
}'DESCRIPTOR$AIWLEB _ LARGE'ELEMENT;
}'DESCRIPTOR$MULTIPLIER _ ELEMENT'SIZE - 1;
}'DESCRIPTOR$UPPER'LIMIT _ UPPER'BOUND;
}'DESCRIPTOR$AIWADDR _
}+IWTNOR@IWTYPE V' ATX@IWTAG V' 0@IWTRAP V' BASE'ADDRESS@IWGD;
}'RETURN DESCRIPTOR;

}'FUNCTION ARRAYSIZE(DESCRIPTOR);

* COMPUTE THE NUMBER OF ELEMENTS IN AN ARRAY.}"NOTE THAT THIS IS THE
* SAME AS THE NUMBER OF WORDS OCCUPPIED BY THE ARRAY ONLY IF THE
* ELEMENTS OF THE ARRAY ARE 1 WORD IN SIZE.
}'UPPER'LIMIT _ (AIWLLIM IF DESCRIPTOR$AIWLEB ELSE AIWNLIM);
}'RETURN (DESCRIPTOR$UPPER'LIMIT - DESCRIPTOR$AIWORG + 1);
}'END;*
}'PROGRAM FILE'RUN;
}'INCLUDE M1'COMM;

}'DECLARE OCTAL PMT'BYTE;
}'DECLARE STRING S;
}'DECLARE POINTER SP;
}'DECLARE FIELD PMT'INDEX(0:16,23);
}'MACRO M1_(FILE=-1 AND M1MODE#0);

* GET M1 FILE CORRESPONDING TO GIVEN FILE
}'FUNCTION M1'FILE(FILE);
}'RETURN (CODE'FILE IF FILE=-1 ELSE BARE'FILE IF FILE=-2
}#ELSE REAL'FILE IF FILE=4B7 ELSE RING'FILES[FILE]);

* FIND NEXT PAGE OF FILE
}'FUNCTION SGNP'(N,REAL'FILE);}"FILE_4B7;
}'FUNCTION SGNP(N,FILE);
}'IF M1 DO;
},WHILE (N_N+1)<64 DO;
}1RETURN N IF READ'MAP'BYTE(USPNO,N//SYSERR)$PMT'INDEX#0;
},ENDFOR;
},RETURN -1;
}'ELSE DO;
},RETURN NEXT'FILE'PAGE(M1'FILE(FILE),N//SYSERR);
}'ENDIF;
}'HALT();* CONTROL SHOULD NEVER REACH HERE

* DELETE PAGE OF FILE (MAY NOT EXIST)
}'FUNCTION SDPG'(N,REAL'FILE);}"FILE_4B7;
}'FUNCTION SDPG(N,FILE);
}'IF M1 DO;
},IF PMT'BYTE_READ'MAP'BYTE(USPNO,N//SYSERR)$PMT'INDEX DO;
}1DELETE'PMT(PMT'BYTE//SYSERR);
},ENDIF;
}'ELSE DO;
},DEL'FILE'PAGE(M1'FILE(FILE),N//SYSERR);
}'ENDIF;
}'RETURN;

* CREATE PAGE OF FILE (MAY ALREADY EXIST)
}'FUNCTION SCPG'(N,REAL'FILE);}"FILE_4B7;
}'FUNCTION SCPG(N,FILE);
}'IF M1 DO;
},IF (PMT'BYTE_READ'MAP'BYTE(USPNO,N//SYSERR)$PMT'INDEX)=0 DO;
}1PMT'BYTE_ACQUIRE'PMT(-1//SYSERR);
}1NEW'PMT'PAGE(PMT'BYTE//SYSERR);
}1SET'PMT'CL(PMT'BYTE,((1 LSH USPNO) V' (1 LSH SSPNO))
}1//SYSERR);
}1SET'MAP'BYTE(USPNO,N,PMT'BYTE//SYSERR);
},ENDIF;
}'ELSE DO;
},CR'FILE'PAGE(M1'FILE(FILE),N//CRE:SYSEC);
}'ENDIF;
}'RETURN;
CRE:}#RETURN IF ERCODE='FPE' ELSE SYS'ERR();

* COLLECT FILE NAME FROM COMMAND STRING AND WRITE IT ON STRING.
* FAIL IF NO NAME OR STRING TOO SHORT, OTHERWISE RETURN STRING
}'STRING FUNCTION CGETF(STRING S), FRETURN;
}'APPEND(S,GET'PARAM(CSTR)//FRETURN);
}'FRETURN IF LENGTH(S)=0;
}'RETURN S;

* CONVERT FILE NAME TO M1 NAME
}'FUNCTION M1'FNAME(S,N,NEW'OK), FRETURN;
}'NAME'SEARCH(S,NAME'BUF,NEW'OK,FILE'TYPES[N A' 7],-1//FRETURN:SYSEC);
}'RETURN;

* OPEN FILE FOR INPUT AND CHECK TYPE
}'FUNCTION OIF(S,N), FRETURN;
}'M1'FNAME(S,N,0//FRETURN);
}'FRETURN IF M1'FILE'TYPE#FILE'TYPES[N A' 7];
}'RETURN OPEN'FILE(-1,NAME'BUF,'RU',-1//FRETURN:SYSEC);

* OPEN FILE FOR OUTPUT AND SET TYPE. SET WORD NUMBER PART OF 
* FILE LENGTH TO MAX VALUE.
}'FUNCTION OOF(S,N), FRETURN;
}'M1'FNAME(S,N,1//FRETURN);
}'FILE_ OPEN'FILE(-1,NAME'BUF,'WU',-1//FRETURN:SYSEC);
}'SET'FILE'LENGTH(FILE,3777B//SYSERR);
}'RETURN FILE;

* CLOSE FILE, ALL FILES
}'FUNCTION CLOSALL();
}'FILE_-1;
}'FUNCTION CLOSE(FILE);
}'CLOSE'FILE(FILE//SYSERR);
}'RETURN;
}'END;*
}'PROGRAM SMAP;
}'INCLUDE M1'COMM;

}'DECLARE OCTAL PMT'BYTE, I, FILE;
}'DECLARE FIELD PMT'INDEX(0:16,23);

* PUT PAGE OF FILE IN MAP - FIRST PASS
}'FUNCTION SMAP'(N,REAL'FILE,X);}"FILE_4B7;
}'FUNCTION SMAP(N,FILE,X);
}'X_X RSH 11;
}'PMT'BYTE_PMT'BYTES[X];
}'IF N=-1 DO;
}+RETURN IF PMT'BYTE<=0;
}+CLEAR'PMT(PMT'BYTE//SYSERR);
}+PMT'USE[X]$PMT'FILE _ PMT'USE[X]$PMT'PAGE _ 0;
}+PMT'BYTE_0;
}'ELSEIF M1MODE=0 OR FILE#-1 DO;
}+IF PMT'BYTE<=0 DO;
}/PMT'BYTES[X]_PMT'BYTE_ACQUIRE'PMT(-1//SYSERR);
}+ELSE DO;
}/SMAP'COUNTER _ SMAP'COUNTER + 1;
}/RETURN IF SMAP'CHECK(M1'FILE(FILE), N, X);
}/CLEAR'PMT(PMT'BYTE//SYSERR);
}/PMT'USE[X]$PMT'FILE _ PMT'USE[X]$PMT'PAGE _ 0;
}+ENDIF;
}+MOVE'PAGE'PMT(M1'FILE(FILE),N,PMT'BYTE//SYSERR);
}+PMT'USE[X]$PMT'FILE _ M1'FILE(FILE);
}+PMT'USE[X]$PMT'PAGE _ N;
}+PUT'PAGE'CWS(PMT'BYTE//SYSERR);
}'ELSE DO;
}+PMT'BYTE_READ'MAP'BYTE(USPNO,N//SYSERR)$PMT'INDEX;
}+FATAL'ERROR() IF PMT'BYTE=0;
}'ENDIF;
}'SET'MAP'BYTE(-1,X,PMT'BYTE//SYSERR);
}'RETURN;

* INITIALIZE PMT BOOK-KEEPING.
}'FUNCTION SMAP'INIT();
}'FOR I _ 0 TO 63 DO;
}+PMT'USE[I]$PMT'FILE _ PMT'USE[I]$PMT'PAGE _ 0;
}'ENDFOR;
}'RETURN;

* CHECK TO SEE IF PAGE IS ALREADY MAPPED IN.
}'FUNCTION SMAP'CHECK(FILE, PAGE, I);
}'IF FILE = PMT'USE[I]$PMT'FILE AND PAGE = PMT'USE[I]$PMT'PAGE DO;
}+REDUNDANT'SMAPS _ REDUNDANT'SMAPS + 1;
}+RETURN 1;
}'ELSE DO;
}+RETURN 0;
}'ENDIF;
}'END;*
}'COMMON SEQ'FILE;
}'INCLUDE M1'COMM, PPDEC, STBD;



}'DECLARE PARAMETER N'SEQ'FILES _ 3;
}'DECLARE ARRAY SEQ'FILE'TABLE[N'SEQ'FILES:21];
}'DECLARE SIGNED FIELD PAGE'IN'WINDOW (0:0,11);
}'DECLARE FIELD PMT'INDX (0:12,19);
}'DECLARE FIELD IN'USE (0:20,20);
}'DECLARE FIELD LARGE'OR'SMALL (0:21,21);
}'DECLARE FIELD INPUT'OR'OUTPUT (0:22,22);
}'DECLARE FIELD BYTE'SIZE (1:0,4);
}'DECLARE FIELD NAME'STORAGE (2);
}'DECLARE STRING FIELD INPUT'DESCRIPTOR(10);
}'DECLARE STRING FIELD OUTPUT'DESCRIPTR (14);
}'DECLARE FIELD LENGTH'IN'CHARS (18);
}'DECLARE FIELD FL'NMBR (19:1,5);
}'DECLARE FIELD WINDOW'ADDR (19:6,23);
}'DECLARE FIELD CHARS'LEFT (20);
}'DECLARE ARRAY SEQ'FILE'WINDOWS[N'SEQ'FILES] _
},(200000B, 204000B, 210000B);
}'DECLARE ARRAYONE OPEN'FILES[16];
}'DECLARE INTEGER CHLF_310B;* SHOULD BE DECLARED IN PPDEC, BUT ISN'T
}'DECLARE FIELD VTA (0:0,12), VPN(0:6,12);
}'END;*
}'PROGRAM OPEN'SEQ'FILE;
}(INCLUDE SEQ'FILE;



}'DECLARE GARBAGE;
}(DECLARE INTEGER SMALL'FILE_0,LARGE'FILE_1;
}'DECLARE INTEGER SEQ'FILE'NUMBER,IOFLAG,NEW'FILE'OK,LENGTH'IN'CHAR,
}(OBJECT'TYPE,ACCESS'KEY,FILE'NUMBER,PAGE'NUMBER,PMT'INDEX, NUTS;
}'DECLARE STRING FILE'NAME, S;
}'DECLARE FIELD LENGTH'FIELD (2:2,23);
}'DECLARE POINTER FILE,WINDOW'ADDRESS;
}'DECLARE ARRAY FORMATTED'NAME;
}'DECLARE ARRAY LENGTH'WORD[3];


*IOFLAG=0 FOR INPUT, 1 FOR OUTPUT

}(FUNCTION OPEN'SEQ'FILE(FILE'NAME,IOFLAG);

}(FOR SEQ'FILE'NUMBER_0 TO N'SEQ'FILES-1 DO;
}+GOTO SET IF SEQ'FILE'TABLE[SEQ'FILE'NUMBER]$IN'USE=0;
}'ENDFOR;
}'CERR(139);* TOO MANY SEQUENTIAL FILES OPEN
SET:}#SEQ'FILE'TABLE[SEQ'FILE'NUMBER]$IN'USE_1;
}'FILE_@SEQ'FILE'TABLE[SEQ'FILE'NUMBER];
}'FORMATTED'NAME_ARRDESC(@(FILE.NAME'STORAGE),8,1,0);
}'NEW'FILE'OK_IOFLAG;
}'NAME'SEARCH(FILE'NAME, FORMATTED'NAME,NEW'FILE'OK,6'9SYM',-1//
},VALUE GOTO READ'FROM'FILE: ERCODE, ERMSNO);
}'ACCESS'KEY_('WU' IF IOFLAG ELSE 'RU');
}'IF FORMATTED'NAME[2]=-1 DO;
}+FILE'NUMBER_OPEN'FILE(-1,FORMATTED'NAME,ACCESS'KEY,-1//
}/VALUE GOTO ABORT: ERCODE, ERMSNO);
}+LENGTH'IN'CHAR_0;
}+OBJECT'TYPE_SMALL'FILE;
}'ELSE DO;
}+CONV'NAME(FORMATTED'NAME, FORMATTED'NAME,-1:
}/GARBAGE,OBJECT'TYPE,GARBAGE//
}/VALUE GOTO ABORT: ERCODE, ERMSNO);
}+IF (OBJECT'TYPE#SMALL'FILE) AND (OBJECT'TYPE#LARGE'FILE) DO;
}/FILE.IN'USE_0;
}/CERR(140);* FILE OF IMPROPER TYPE
}+ELSE DO;
}/READ'MIBOB'VALUE(FORMATTED'NAME,1,LENGTH'WORD,2,-1//
}?VALUE GOTO ABORT: ERCODE, ERMSNO);
}/FILE'NUMBER_OPEN'FILE(-1,FORMATTED'NAME,ACCESS'KEY,-1//
}?VALUE GOTO ABORT: ERCODE, ERMSNO);
}/LENGTH'IN'CHAR_(0 IF NEXT'FILE'PAGE(FILE'NUMBER,-1//
}?SYSERR)=-1 ELSE 3*
}'((2048*((LENGTH'WORD[2]$VTA)-1))+(LENGTH'WORD[2]$VWA)+1));
}/IF (LENGTH'IN'CHAR) AND (IOFLAG) DO;
}3PAGE'NUMBER_-1;
}3WHILE PAGE'NUMBER_NEXT'FILE'PAGE(
}4FILE'NUMBER,PAGE'NUMBER//SYSERR)#-1 DO;
}7DEL'FILE'PAGE(FILE'NUMBER,PAGE'NUMBER//SYSERR);
}3ENDFOR;
}3SET'FILE'LENGTH(FILE'NUMBER,0//SYSERR);
}3LENGTH'IN'CHAR_0;
}/ENDIF;
}+ENDIF;
}'ENDIF;
}'FILE.PMT'INDX_ACQUIRE'PMT(-1//SYSERR);
}'FILE.WINDOW'ADDR_SEQ'FILE'WINDOWS[SEQ'FILE'NUMBER];
}'NUTS_FILE.WINDOW'ADDR$VPN;
}'SET'MAP'BYTE(-1,NUTS,FILE.PMT'INDX//SYSERR);
}'OPEN'FILES[FILE'NUMBER]_SEQ'FILE'NUMBER;
}'SETUP(S,0,FILE.WINDOW'ADDR,8);
}'FILE.OUTPUT'DESCRIPTR_S;
}'FILE.INPUT'DESCRIPTOR_S;
}'FILE.FL'NMBR_FILE'NUMBER;
}'FILE.LARGE'OR'SMALL_(0 IF OBJECT'TYPE=SMALL'FILE ELSE 1);
}'FILE.LENGTH'IN'CHARS_LENGTH'IN'CHAR;
}'FILE.CHARS'LEFT_LENGTH'IN'CHAR;
}'FILE.BYTE'SIZE_8;
}'FILE.PAGE'IN'WINDOW_-1;
}'FILE.INPUT'OR'OUTPUT_IOFLAG;
}'RETURN FILE'NUMBER;
READ'FROM'FILE:FILE.IN'USE_0;
}'CERR(141);* ATTEMPT TO READ FROM NON-EXISTENT FILE
ABORT:
}(FILE.IN'USE_0;
}'SYS'ERR();
}'END;*
}'PROGRAM GCI'FROM'FILE;

}(INCLUDE SEQ'FILE;


}(DECLARE POINTER FILE;
}'DECLARE STRING OUTPUT'LINE,J,S;
}'DECLARE INTEGER CHAR,FILE'NUMBER,NEXT'PAGE,I;

}(STRING FUNCTION GCI'FROM'FILE(FILE'NUMBER, STRING OUTPUT'LINE),
}(FRETURN;

}(FILE_@SEQ'FILE'TABLE[OPEN'FILES[FILE'NUMBER]];
READ:}'J_FILE.INPUT'DESCRIPTOR;
}(CHAR_GCI(J//VALUE NEW'PAGE(FILE//CHECK)
}(& GOTO READ) A' 177B;
}'FILE.INPUT'DESCRIPTOR_J;
}'IF CHAR<135B DO;
}+WCI(CHAR,OUTPUT'LINE//VALUE PXERR(132));
}'ELSE DO;
}+IF CHAR=135B DO;*MULTIPLE BLANKS
BLANKS:}(J_FILE.INPUT'DESCRIPTOR;
}0CHAR_CHMB1+(GCI(J//VALUE
}0NEW'PAGE(FILE//ZERO) & GOTO BLANKS)) A' 77B;
}/FILE.INPUT'DESCRIPTOR_J;
}+ELSEIF CHAR=155B DO;*CARRAIGE RETURN
CARRAIGE:}(J_FILE.INPUT'DESCRIPTOR;
}0IF (GCI(J//VALUE NEW'PAGE(FILE//
}0CARR) & GOTO CARRAIGE)) A' 177B=152B DO;
}/FILE.INPUT'DESCRIPTOR_J;
}3CHAR_CHNL;
}/ELSE DO;
}3CHAR_CHAR V' 200B;
}3J_FILE.INPUT'DESCRIPTOR;
}3J$RP _ INCDES(J$RP,-1);
}3FILE.INPUT'DESCRIPTOR_J;
}/ENDIF;
}+ELSEIF CHAR=152B DO;
}/CHAR_CHLF;*310B
}+ELSEIF CHAR>140B DO;
}/CHAR_CHAR V' 200B;
}+ENDIF;
}+WCI(CHAR, OUTPUT'LINE//VALUE PXERR(132));
}+RETURN OUTPUT'LINE IF CHAR=CHNL;
}'ENDIF;
}'GOTO READ;
ZERO:
}(WCI(200B, OUTPUT'LINE//VALUE PXERR(132));
}'RETURN OUTPUT'LINE;
CARR:
}(WCI(355B, OUTPUT'LINE//VALUE PXERR(132));
}'RETURN OUTPUT'LINE;
CHECK:
}(RETURN OUTPUT'LINE IF LENGTH(OUTPUT'LINE)>0;
}'FRETURN;






}(FUNCTION NEW'PAGE(FILE),FRETURN;

}(RUNTIME'FAILURE() IF FILE.IN'USE=0;
}'CERR(142) IF FILE.INPUT'OR'OUTPUT;* FILE NOT OPEN FOR INPUT
}'IF FILE.CHARS'LEFT<=0 DO;
}+FRETURN;
}'ELSE DO;
}+NEXT'PAGE_FILE.PAGE'IN'WINDOW+1;
}+CLEAR'PMT(FILE.PMT'INDX//SYSERR);
}+MOVE'PAGE'PMT(FILE.FL'NMBR,NEXT'PAGE,FILE.PMT'INDX//SYSERR);
}+FILE.PAGE'IN'WINDOW_NEXT'PAGE;
}+IF FILE.CHARS'LEFT>3*4000B DO;*MORE THAN 1 PAGE LEFT
}+SETUP(S,3*4000B,FILE.WINDOW'ADDR,8);
}/FILE.INPUT'DESCRIPTOR_S;
}/FILE.INPUT'DESCRIPTOR$WP_FILE.INPUT'DESCRIPTOR$EP;
}/FILE.CHARS'LEFT_FILE.CHARS'LEFT-3*4000B;
}+ELSE DO;*LAST PAGE
}+SETUP(S,FILE.CHARS'LEFT,FILE.WINDOW'ADDR,8);
}/S$WP _ S$EP;
}/S$RP _ INCDES(S$EP, -3);
}/FOR I _ 1 TO 3 DO;
}3GOTO END'OF'FILE IF (CHAR _ (GCI(S) A' 177B) = 137B);
}/ENDFOR;
END'OF'FILE:}#S$WP _ INCDES(S$RP, -1) IF CHAR = 137B;
}/SETR(S, 0);
}/FILE.INPUT'DESCRIPTOR _ S;
}/FILE.CHARS'LEFT _ 0;
}+ENDIF;
}'ENDIF;
}'RETURN;
}'END;*
}'PROGRAM WCI'TO'FILE;

}(INCLUDE SEQ'FILE;


}(DECLARE POINTER FILE;
}'DECLARE INTEGER FILE'NUMBER,CHAR,NEXT'PAGE;
}'DECLARE STRING INPUT'LINE,T,S;

}(FUNCTION WCI'TO'FILE(FILE'NUMBER,STRING INPUT'LINE);

}(FILE_@SEQ'FILE'TABLE[OPEN'FILES[FILE'NUMBER]];
RD:
}(CHAR_GCI(INPUT'LINE//RETURN);
}'IF CHAR>340B DO;
}+CHAR_CHAR A' 177B;
}'ELSEIF ((CHAR>=200B) AND (CHAR<=277B)) DO;
MB:
}/T_FILE.OUTPUT'DESCRIPTR;
},WCI(135B,T//VALUE CREATE(FILE) & GOTO MB);
}/FILE.OUTPUT'DESCRIPTR_T;
}+CHAR_CHAR A' 77B;
}'ELSEIF CHAR=307B DO;
NL:
}'T_FILE.OUTPUT'DESCRIPTR;
},WCI(155B,T//VALUE CREATE(FILE) & GOTO NL);
}'FILE.OUTPUT'DESCRIPTR_T;
}+CHAR_152B;
}'ELSEIF CHAR=310B DO;
}+CHAR_152B;
}'ENDIF;
WT:
}'T_FILE.OUTPUT'DESCRIPTR;
}(WCI(CHAR,T//VALUE CREATE(FILE) & GOTO WT);
}'FILE.OUTPUT'DESCRIPTR_T;
}'GOTO RD;




}(FUNCTION CREATE(FILE);


}(RUNTIME'FAILURE() IF FILE.IN'USE=0;
}'CERR(143) IF FILE.INPUT'OR'OUTPUT=0;* FILE NOT OPEN FOR OUTPUT
}'NEXT'PAGE_FILE.PAGE'IN'WINDOW+1;
}'CR'FILE'PAGE(FILE.FL'NMBR,NEXT'PAGE//SYSERR);
}'CLEAR'PMT(FILE.PMT'INDX//SYSERR);
}'MOVE'PAGE'PMT(FILE.FL'NMBR,NEXT'PAGE,FILE.PMT'INDX//SYSERR);
}'FILE.PAGE'IN'WINDOW_NEXT'PAGE;
}'SETUP(S,3*4000B,FILE.WINDOW'ADDR,8);
}'FILE.OUTPUT'DESCRIPTR_S;
}'IF NEXT'PAGE DO;
}+FILE.LENGTH'IN'CHARS_FILE.LENGTH'IN'CHARS + 3*4000B;
}'ENDIF;
}'RETURN;
}'END;*
}'PROGRAM CLOSE'SEQ'FILE;


}(INCLUDE SEQ'FILE;


}(DECLARE STRING END'FILE_"&137";
}'DECLARE INTEGER FILE'NMBR,ND,EF;
}'DECLARE POINTER FILE;
}'DECLARE INTEGER LENGTH'IN'WORDS;


}/DECLARE STRING W;
 
 
}(FUNCTION CLOSE'SEQ'FILE(FILE'NMBR);


}(FILE_@SEQ'FILE'TABLE[OPEN'FILES[FILE'NMBR]];
}'CERR(144) IF FILE.IN'USE=0;* ATTEMPT TO RECLOSE CLOSED FILE
}'IF FILE.INPUT'OR'OUTPUT DO;*OUTPUT FILE
}+WCI'TO'FILE(FILE'NMBR, END'FILE);
}+W _ FILE.OUTPUT'DESCRIPTR;
}+ND _ LENGTH(W);
}+LENGTH'IN'WORDS _ (ND*(FILE.BYTE'SIZE) + 23)/24;
}+SET'FILE'LENGTH(FILE'NMBR, LENGTH'IN'WORDS - 1//SYSERR);
}'ENDIF;
}'CLOSE'FILE(FILE'NMBR//SYSERR);
}'FILE.IN'USE_0;
}'OPEN'FILES[FILE'NMBR]_-1;
}'DELETE'PMT(FILE.PMT'INDX//SYSERR);
}'RETURN;
}'END;*
}'PROGRAM SEQ'IO'INIT;


}(INCLUDE SEQ'FILE;
}'DECLARE INTEGER SEQ'FILE'NUM,OPEN'FILE'NUM;




}(FUNCTION SEQ'IO'INIT();

}(FOR SEQ'FILE'NUM_0 TO N'SEQ'FILES-1 DO;
}+SEQ'FILE'TABLE[SEQ'FILE'NUM]$IN'USE_0;
}'ENDFOR;
}'FOR OPEN'FILE'NUM_1 TO 16 DO;
}+OPEN'FILES[OPEN'FILE'NUM]_-1;
}'ENDFOR;
}'RETURN;

}(END;*
}'PROGRAM SP'ENTRIES;
}'INCLUDE M1'COMM;

* INITIAL ENTRY POINT
}'FUNCTION I'E(), SP'ENTRY_2;
}'SP'_INIT'SP;
}'SL'_INIT'SL;
}'SPL'INIT();

* CONTINUE ENTRY POINT
}'FUNCTION C'E(), SP'ENTRY_3;
}'SP'_INIT'SP;
}'SL'_INIT'SL;
}'SPL'CONT();

}'PROGRAM SPL'INIT;
}'INCLUDE M1'COMM;

}'DECLARE INTEGER I;

* INITIALIZE SPL
}'FUNCTION SPL'INIT();
}'PMT'BYTES[I] _ 0 FOR I _ 0 TO 63;
}'SMAP'INIT();
}'SMAP'COUNTER _ REDUNDANT'SMAPS _ 0;
}'SEQ'IO'INIT();
}'SSPNO_ READ'SPS'PARAM('CSP'//FTLERR: SYSEC);
}'SPL'SPCSL _ READ'SPS'PARAM('CSL'//SYSERR);
}'PROCNO _ READ'PROC'PARAM('PRT'//FTLERR: SYSEC);
}'CREATE'RING'FILE(0);
}'SAVED'OLCWS _ READ'LWS('OCW'//SYSERR);
}'SAVED'OLDWS _ READ'LWS('ODW'//SYSERR);
}'DESIRED'OLCWS _ OPTIMAL'OLCWS;
}'DESIRED'OLDWS _ OPTIMAL'OLDWS;
}'SET'WS'SIZE(DESIRED'OLCWS, DESIRED'OLDWS);
}'M1MODE_1;
*** NOW WHAT ?
}'SPL();
* CONTINUE SPL
}'FUNCTION SPL'CONT();
}'SET'WS'SIZE(DESIRED'OLCWS, DESIRED'OLDWS);
}'CSPL();

}'PROGRAM CREATE'RING'FILE;
}'INCLUDE M1'COMM;
}'DECLARE STRING FILE'NAME(30);
}'DECLARE CHARACTER ARRAY RINGS[NRINGS] _ ('0', '1', '2');
}'DECLARE INTEGER FILE'NUMBER, OBJECT'TYPE, GARBAGE;
}'DECLARE PARAMETER SMALL'FILE _ 0, LARGE'FILE _ 1;

}'FUNCTION CREATE'RING'FILE(RING'NUMBER);
* CONSTRUCT FILE NAME.}"THIS NAME HAS THE FORM:
*}""RING-<RING-NUMBER>-DATA-<PROCESS-NUMBER>-<SUB-PROCESS-NUMBER>:RING"
* WHERE <RING-NUMBER> IS THE ARGUMENT PASSED TO CREATE'RING'FILE;
*}'<PROCESS-NUMBER> IS THE (DECIMAL) PRT INDEX OF THE PROCESS
*}.WE'RE RUNNING IN, TRUNCATED TO 2 DIGITS;
*}'<SUB-PROCESS-NUMBER> IS THE (DECIMAL) SUB-PROCESS NUMBER OF
*}.SPL, TRUNCATED TO 1 DIGIT.
* A TYPICAL FILE NAME WILL BE:
*}""RING-0-DATA-9-2:RING".
}'SETS(FILE'NAME);
}'SCOPY(FILE'NAME, "&"RING-"//VALUE RUNTIME'FAILURE());
}'WCI(RINGS[RING'NUMBER], FILE'NAME);
}'APPEND(FILE'NAME, "-DATA-"//VALUE RUNTIME'FAILURE());
}'CNS(PROCNO, FILE'NAME, 2, 10//VALUE RUNTIME'FAILURE());
}'WCI('-', FILE'NAME);
}'CNS(SSPNO, FILE'NAME, 1, 10//VALUE RUNTIME'FAILURE());
}'APPEND(FILE'NAME, ":RING&""//VALUE RUNTIME'FAILURE());
* SEE IF THERE'S ALREADY AN OBJECT WITH THIS NAME.
}'NAME'SEARCH(FILE'NAME, NAME'BUF, 1, 6'RING', -1//SYSERR);
}'IF NAME'BUF[2] # -1 DO;* OLD FILE
}+CONV'NAME(NAME'BUF, NAME'BUF, -1:GARBAGE,OBJECT'TYPE,GARBAGE//SYSERR);
}+FATAL'ERROR() IF
}/(OBJECT'TYPE # SMALL'FILE AND OBJECT'TYPE # LARGE'FILE);
}+DELETE'FILE(NAME'BUF, -1//SYSERR);
}'ENDIF;
* CREATE A LARGE FILE.
}'CREATE'MIBOB(NAME'BUF, LARGE'FILE, CONV'KEY(-1//SYSERR)//SYSERR);
}'NAME'BUF[2] _ 0;
}'FILE'NUMBER _ OPEN'FILE(-1, NAME'BUF, 'WU', -1//SYSERR);
}'SET'FILE'LENGTH(FILE'NUMBER, 3777B//SYSERR);
}'RING'FILES[RING'NUMBER] _ FILE'NUMBER;
}'RETURN;
}'END;

}'PROGRAM SET'WS'SIZE;
}'INCLUDE M1'COMM;

}'DECLARE INTEGER MAX'CWS, MAX'DWS;

}'FUNCTION SET'WS'SIZE(TARGET'OLCWS, TARGET'OLDWS);
* READ MAXIMUM ALLOWED VALUES FOR OLCWS AND OLDWS.
}'MAX'CWS _ READ'LWS('MCW'//SYSERR);
}'MAX'DWS _ READ'LWS('MDW'//SYSERR);
* ADJUST TARGET VALUES IF NECESSARY.
}'TARGET'OLCWS _
}+(TARGET'OLCWS IF TARGET'OLCWS <= MAX'CWS ELSE MAX'CWS);
}'TARGET'OLDWS _
}+(TARGET'OLDWS IF TARGET'OLDWS <= MAX'DWS ELSE MAX'DWS);
* REDUCE THE WORKING SETS IF THEY'RE LARGER THAN THE TARGET LENGTHS.
}'DEL'PAGE'CWS(-1//SYSERR) WHILE TARGET'OLCWS < READ'LWS('CWS'//SYSERR);
}'DEL'PAGE'DWS(-1//SYSERR) WHILE TARGET'OLDWS < READ'LWS('DWS'//SYSERR);
* SET NEW OVERFLOW LENGTHS.
}'IF TARGET'OLCWS >= READ'LWS('OCW'//SYSERR) DO;
}+SET'LWS('ODW', TARGET'OLDWS//SYSERR);
}+SET'LWS('OCW', TARGET'OLCWS//SYSERR);
}'ELSE DO;
}+SET'LWS('OCW', TARGET'OLCWS//SYSERR);
}+SET'LWS('ODW', TARGET'OLDWS//SYSERR);
}'ENDIF;
}'RETURN;
}'END;

}'PROGRAM SUBSTITUTES;
}'INCLUDE M1'COMM;

* CREATE USER SUBPROCESS
}'FUNCTION ZDEM1(FLG);
}'IF FLG=0 DO;
}'USPNO_CREATE'SSP(-1//SYSERR);
}'ENDIF;
}'RETURN;
* LABEL FIXER NEEDED FOR CPU 1.0
}'LABEL FUNCTION LABEL'FIXER(LABEL FIX'ME'LABEL);
}'RETURN FIX'ME'LABEL;
* ARRAY DESCRIPTOR FIXER
}'ARRAY FUNCTION ARRAY'FIXER(ARRAY FIX'ME'ARRAY);
}'RETURN FIX'ME'ARRAY;
* REAL ARRAY DESCRIPTOR FIXER
}'ARRAY FUNCTION REAL'ARRAY'FIXER(REAL ARRAY REAL'ARRAY);
}'RETURN REAL'ARRAY;

* QUIT FLAG TESTER
}'FUNCTION IFQUIT(), FRETURN;
}'FRETURN IF QUITF#0 ELSE RETURN;

}'PROGRAM TOOLS;
}'INCLUDE M1'COMM;

}'DI I,J,K;
}'DA PMTE[5],MIBE[10];
}'DP PMTA;
}'DS MIBS;
}'DI PMTX,MAPX,SPTX,OBTX;
}'DI OLDCL,OLDAL,NEWCL,NEWAL,OLDUN1,OLDUN2,NEWUN1,NEWUN2;
}'DECLARE LONG UNDK_(-1,0);
}'DS PMTS1_"#: #",PMTSL_" CL=# AL=#",PMTS2_" RO";
}'DS PMTS3_": ",PMTS4_",*",PMTS5_" --";

}'DF PMTCL(3:15,23),PMTAL(3:3,11),PMTRO(3:0,0),PMTFP(2:0,0);
}'DF PMTUN1(0),PMTUN2(1),UN1F(0:2,23),UN2F(0:0,15),UN2I(0:16,23);

* LIST MAP FOR GIVEN SUBPROCESS
}'FUNCTION LM(SPTX);
}'SPTX_USPNO IF SPTX=0;
}'PMTA_@PMTE[0];
}'SETUP(MIBS,20,@MIBE[2],6);
}'OLDCL_OLDAL_OLDUN1_OLDUN2_-1;
}'FOR MAPX_0 TO 77B DO;
}+IF PMTX_READ'MAP'BYTE(SPTX,MAPX//SYSERR) DO;
}/READ'PMT(PMTX A' 377B,PMTE//SYSERR);
}/FMTO(PMTS1); OUT(MAPX); OUT(PMTX);
}/NEWCL_PMTA.PMTCL; NEWAL_PMTA.PMTAL;
}/IF NEWCL#OLDCL OR NEWAL#OLDAL DO;
}3FMTO(PMTSL); OUT(OLDCL_NEWCL); OUT(OLDAL_NEWAL);
}/ELSE DO;
}3CSOUT(PMTS5);
}/ENDIF;
}/CSOUT(PMTS2) IF PMTA.PMTRO;
}/IF PMTA.PMTFP DO;
}3CSOUT(PMTS3);
}3NEWUN1_PMTA.PMTUN1$UN1F;
}3NEWUN2_PMTA.PMTUN2$UN2F;
}3GOTO RSAME IF NEWUN1=OLDUN1 AND NEWUN2=OLDUN2;
}3FOR OBTX_0 TO 177B DO;
}7READ'MIBOB'INDEX(UNDK,8,MIBE,OBTX,0//RFAIL:SYSEC);
}7GOTO RFOUND IF MIBE[8]$UN1F=NEWUN1
}8AND MIBE[9]$UN2F=NEWUN2;
RFAIL:}-ENDFOR;
RRET:}*ENDIF;
}/CSOUT("&/");
}+ENDIF;
}'ENDFOR;
}'RETURN;
RFOUND:OLDUN1_NEWUN1; OLDUN2_NEWUN2;
}'SETS(MIBS,0,16);
}'COUT(I,-1) WHILE I_GCI(MIBS//RTYPE);
RTYPE: COUT(':',-1);
}'SETS(MIBS,16,20);
}'CSOUT(MIBS);
RPAGE: FMTO(PMTS4); OUT(PMTA.PMTUN2$UN2I);
}'GOTO RRET;
RSAME: CSOUT(PMTS5);
}'GOTO RPAGE;