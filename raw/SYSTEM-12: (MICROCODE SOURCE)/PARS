@}&NOLIST EXT
}'MACRO DP_DEFINE PARAMETER;
}'MACRO DE_DEFINE REGISTER;
}'MACRO SC_DEFINE SCONDITION;
}'MACRO BC_DEFINE BCONDITION;

* MISCELLANEOUS
}'DP ADMASK_77000000B;

* SIZES AND LOCATIONS OF THINGS IN THE USCHEDULER
}'DP NPRI_8;
* THIS PROGRAM WILL NOT WORK WITH MORE THAN TWO
* CPUS. THE EXISTENCE OF JUST TWO IS WOVEN INTO THE CODE IN SEVERAL
* PLACES.
}'DP NCPU_2;
* CONVENTIONS FOR ACCESS LEVELS: INCREMENT BY RCY 4, IDLE IS 4B7
}'DP ALIDLE_4B7;
}'DP ALRUNNING_2B6;
}'DP ALPRIMED_1B5;
* CONVENTIONS FOR PRIORITIES: 0 TO NPRI-1, WITH 0 MOST IMPORTANT
}'DP LUSIBE_2;},* LENGTH OF USIB ENTRY
}'DP MAXUOP_10;}+* MAX LEGAL OPCODE FOR USIB ENTRY
}'DP LSCRATCH_32;})* SIZE OF SCRATCHPAD

* FIELDS IN A PRT ENTRY
}'DP RTBIT_1; DP RSIBIT_2;
}'DP RESBIT_4; DP CPUBIT_1; DP RUNBIT_2; DP LDDBIT_10B;
}'DP USQBIT_20B; DP SCQBIT_40B; DP SWQBIT_100B; DP PQBIT_200B;
}'DP PDKBIT_400B; DP CBCBIT_1000B; DP WAQBIT_2000B; DP BLKBIT_4000B;
}'DP PRRTP_6; DP PRRT_7;
}'DP PRST_8; DP PRPIW_3;
}'DP PRPTR_11;
}'DP RTPMSK_77000000B;
}'DP PRIMASK_160000B;

* FIXED CORE LOCATIONS FOR COMMUNICATING WITH OTHER PEOPLE
}'DP RTC_10B;}-* REAL-TIME CLOCK (48 BITS). WE ARE
* INTERESTED IN BITS 15-37. THE MOST SIGNIFICANT BITS ARE IN THE
* FIRST WORD
}'DP RTQ_16B;}-* HEAD OF REAL-TIME QUEUE
}'DP USIBTOP_15B;})* POINTER TO TOP OF USIB
}'DP USIBASE_14B;})* POINTER TO BASE OF USIB
}'DP SWFREL_110B;})* HEAD OF FREELIST OF SWAPPER NODES
}'DP SWAPIQ_106B;})* HEAD OF QUEUE FOR SWAPIN REQUESTS
}'DP SWAPRQ_104B;})* HEAD OF SWAPPER GENERAL REQUEST QUEUE
}'DP RIPQ_114B;}+* HEAD OF SWAPPER READ IN PROGRESS Q
}'DP CPUPROC_6;}+* PROCESSES FOR CPU(S) TO RUN
}'DP USQBASE_310B;
}'DP WAKEUPQ_300B;

* PARAMETERS DEFINING THE SAVE AREA, USED BY THE STATE STORE AND
* LOAD ROUTINES
}'DP SAVE_2620B;}** SHOULD BE 2620B ON BOARDS
}'DP SAVER0_SAVE+LSCRATCH;
* THE CODE SAVES R0-R6, OS, QAND Z IN SEQUENCE
}'DP SAVER1_SAVER0+1;
}'DP SAVEZ_SAVER0+9;
* A SCRATCHPAD LOCATION MUST BE DEDICATED TO SAVING M
}'DE SK0 AS SSMREG;
* THE O REGISTER IS RESTORED FROM
}'DP BREAK_21B;
* AND WE WAIT AFTER STORING THE STATE FOR
}'DP BRKWAIT_26B;
* TO BECOME NON-ZERO BEFORE STARTING TO RELOAD

* LOCATION OF FOUR-WORD ERROR TABLE FOR US
}'DP USERRTAB_2444B;


* PARAMETERS FOR THE ADDRESSES OF SYSTEM REGISTERS.}"THE REGISTERS
* ARE ASSUMED TO APPEAR IN SEQUENCE AS LISTED
}'DP USRADR_1;
}'DP SWR1ADR_USRADR; DP SWR2ADR_USRADR+1; DP SWR3ADR_USRADR+2;
}'DP SWR4ADR_USRADR+3; DP SWR5ADR_USRADR+4;
}'DP SSRADR_USRADR+5; DP SCRADR_USRADR+6; DP SSLADR_USRADR+7;
* PARAMETERS FOR THE MEMORY REPRESENTATION OF THE REGISTERS
}'DP USRMEM_30B;
}'DP SWR1MEM_USRMEM; DP SWR2MEM_USRMEM+1; DP SWR3MEM_USRMEM+2;
}'DP SWR4MEM_USRMEM+3; DP SWR5MEM_USRMEM+4;
}'DP SSRMEM_USRMEM+5; DP SCRMEM_USRMEM+6; DP SSLMEM_USRMEM+7;
* PARAMETERS FOR BITS IN SCR
}'DP SCR_5
}'DP SELFILLBIT_1; DP COMPUTEBIT_2;
}'DP GOBIT_4B7; DP CONTINUEBIT_2B7; * GOBIT TESTED BY SIGN TEST IN CODE

* MACROS FOR READING DATA WORDS.}"THE PREVIOUS INSTRUCTION SHOULD
* READ
* Z_ADDRESS, ALERT
* AND THE MACRO US USED THUS:
* M_READ
* WHERE ANY REGISTER WHICH CAN BBE LOADED FROM Y CAN BE USED
* IN PLACE OF M
}'MACRO READ_E2, PIN, .VCY;

* PROTECTS
}'MACRO PROTECT_.C_*1*, .TCX, SETPRO, GOTO * IF PRONEX;
}'MACRO UNPROTECT_.BL_7B .BR_10B .TAX, CLRPRO;
}'DP USIBPRO_8;
}'DP PRTPRO_1;
}'DP SWAPRO_2;
}'DP ALLPRO_17B;

* STROBE
}'DP CPUSTSH_3;}+* SHIFT CPU#(1 OR 2) TO GET STROBE
}'DP SWAPSTROBE_1;
}'DP CHIOSTROBE_4;
* MISCELLANEOUS
}'DP SWAPOP_1;},* RCASA FOR SWAPPER REQUESTS
}'DP SWNPTR_5;},* POINTER WORD IN SWAPPER REQUEST NODES

* REGISTER DEFINITIONS
}'DE SK1 AS WNPFLG;}'* SET IF WAITING FOR CPU TO UNPRIME
}'DE SK2 AS OLDRT;}(* LAST CLOCK VALUE
}'DE SK3 AS TRTQT;}(* TIME FOR TOP OF RTQ
}'DE SK4 AS SCHFLG;}'* SET IF RESCHEDULING REQUIRED
}'DP LOCSCHFLG_4;
}'DE SK5 AS MINPRT;}'* MINIMUM PRT ADDRESS
}'DE SK6 AS MAXPRT;}'* MAXIMUM PRT ADDRESS
}'DE SK7 AS SPT1;
}'DE SK8 AS SPT2;
}'DE SK9 AS SPT3;})* CHANGERT ONLY
}'DE SK9 AS OLDOLDRT;
}'DE SK10 AS SPT4;
}'DE SK11 AS ADMREG;}&* TRUE ADMASK: 777777B
}'DE SK13 AS CALLT1;
}'DP AL_14;
}'DE SK14 AS AL0;
}'DE SK15 AS AL1;
}'DP PRI_16;
}'DE SK16 AS PRI0;
}'DE SK17 AS PRI1;

* THE TOP 4 BITS OF
}'DE SK28 AS MODE;
* ARE USED TO INDICATE THE MODES, AS FOLLOWS
}'DP ONCOMPUTE_4B7; DP WAITCOMPUTE_2B7;
}'DP ONSCHEDULE_1B7; DP SAVESCHEDULE_4B6;
* ASSUME THAT THESE BITS AND A MEMORY ADDRESS=0

*}"THE FOLLOWING SCRATCHPAD LOCATIONS ARE USED BY THE ITP
* THEY AND MODE MUST BE THE TOP 4
}'DE SK29 AS IOCTL;}'* I/O CONTROL WORD
}'DP LOCIOCTL_29;
}'DE SK30 AS REL;})* RELOCATION FOR RELATIVE ADDRESSES
}'DE SK31 AS BOUND;}'* MEMORY BOUND FOR RELATIVE ADDRESSES
* STORABE FOR THE CENTRAL REGISTERS OF THE ITP
}'DE SK24 AS P;
}'DE SK25 AS AR;
}'DE SK26 AS BR;
}'DE SK27 AS XR;
* THE US CAN START ITS STACK JUST BELOW THE ITP'S REGISTERS
}'DP TOPSTACK_23;
* CORE LOCATIONS FROM WHICH TO INITIALIZE REL AND BOUND
}'DP ITPREL_2B6+306B; DP ITPBND_ITPREL+1;

}'DE R0 AS MAR;
}'DE R1 AS TEMP1;})* CHRT, TIMINT AND IBEMPTY ONLY
}'DE R1 AS CPROC;
}'DE R2 AS TEMP2;
}'DE R3 AS TEMP3;
}'DE R4 AS TEMP4;
}'DE R4 AS OFFSET;
}'DE R5 AS SUBR;
}'DE R6 AS STKP;

* BRANCH CONDITIONS
}'BC R0<0,BR0NEG_11B,(SKN R0),NOVCY;
}'BC R0>=0,BR0POS_12B,(SKP R0),NOVCY;
}'BC NULLPTR_14B,(BRM XNPTR);
}'BC NNPTR_15B,(BRM XNNPTR);
}'BC Z>=0,BZPOS_16B,(SKP Z),NOVCY;
}'BC Z<0,BZNEG_17B,(SKN Z),NOVCY;
}'BC Y.7#0,YA7IS0_21B,(BRM XYA7);
}'BC LB=0,BLBEQ0_22B,(BRM LBEQ0),NOVCY;
}'BC LB#0,BLBNE0_23B,(BRM LBNE0),NOVCY;
}'BC YEVEN_24B,(BRM XYEVEN),NOVCY;
}'BC YODD_25B,(BRM XYODD),NOVCY;
}'BC AT1OFF_26B,(BRM XAT1F),NOVCY;
}'BC NOSTROBE_27B,(BRM STROFF),NOVCY;
}'BC PRONEX_30B,(BRM XPRONE);
}'BC NOCRASH_31B,(SKP FAILF),NOVCY;
}'BC ASET_33B,(SKN AFLAG),NOVCY;
}'BC ACLEAR_32B,(SKP AFLAG),NOVCY;
}'BC AT2OFF_34B,(BRM XAT2F),NOVCY;
}'BC AT3OFF_35B,(BRM XAT3F),NOVCY;
}'BC AT1ON_36B,(BRM XAT1N),NOVCY;
}'BC LMPARITY_42B,(NOP),NOVCY;
}'BC CMPARITY_43B,(NOP),NOVCY;
}'BC BRKON_45B,(BRM XBRKON),NOVCY;

* SPECIAL CONDITIONS
}'SC ALERT_14B,(BRM XALERT);
}'SC POT_15B,(BRM XPOT),NOVCY;
}'SC PIN_16B,(BRM XPIN);
}'SC STROBE_17B,(BRM SETSTR);
}'SC CLRPRO_20B,(BRM CPRO),NOVCY;
}'SC LMPRI_22B,(NOP),NOVCY;
}'SC CLSTROBE_23B,(BRM XCLSTR),NOVCY;
}'SC CLRCM_24B,(NOP),NOVCY;
}'SC SETPRO_25B,(BRM SPRO);
}'SC SETA_30B,(BRM XSETA),NOVCY;
}'SC CLRA_31B,(BRM XCLRA),NOVCY;

}'SC CLFAIL_32B,(MIN FAILF),NOVCY;
}'SC SETFAIL_33B,(NOP);

}'END;